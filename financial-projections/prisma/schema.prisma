// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

model Settings {
  id                    String      @id @default(cuid())
  initialBankBalance    Decimal     @db.Decimal(10, 2)
  initialBalanceDate    DateTime    @db.Date  // The date when initial balance is set (typically today on first launch)
  currency              Currency    @default(GBP)
  dateFormat            DateFormat  @default(UK)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
}

enum EventType {
  EXPENSE
  INCOMING
}

enum CertaintyLevel {
  UNLIKELY
  POSSIBLE
  LIKELY
  CERTAIN
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  ANNUAL
}

enum Currency {
  GBP
  USD
}

enum DateFormat {
  UK   // DD/MM/YYYY
  US   // MM/DD/YYYY
}

model RecurringProjectionEventRule {
  id          String                @id @default(cuid())
  name        String
  description String?
  value       Decimal               @db.Decimal(10, 2)
  type        EventType
  certainty   CertaintyLevel
  payTo       String?               // for expenses
  paidBy      String?               // for incoming

  // Decision path for scenario modeling
  decisionPathId String?
  decisionPath   DecisionPath?     @relation(fields: [decisionPathId], references: [id], onDelete: SetNull)

  // Recurrence definition
  startDate   DateTime              @db.Date
  endDate     DateTime              @db.Date  // Required to prevent infinite event generation
  frequency   RecurrenceFrequency   @default(MONTHLY)

  // Generated events
  projectionEvents ProjectionEvent[]

  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@index([decisionPathId])
  @@index([startDate])
}

model ProjectionEvent {
  id          String          @id @default(cuid())
  name        String
  description String?
  value       Decimal         @db.Decimal(10, 2)
  type        EventType
  certainty   CertaintyLevel
  payTo       String?         // for expenses
  paidBy      String?         // for incoming
  date        DateTime        @db.Date

  // Decision path for scenario modeling
  decisionPathId String?
  decisionPath   DecisionPath? @relation(fields: [decisionPathId], references: [id], onDelete: SetNull)

  // Link to recurring rule (if generated from one)
  recurringRuleId String?
  recurringRule   RecurringProjectionEventRule? @relation(fields: [recurringRuleId], references: [id], onDelete: Cascade)

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([date])
  @@index([decisionPathId])
  @@index([recurringRuleId])
}

model DailyBalance {
  id              String   @id @default(cuid())
  date            DateTime @db.Date @unique
  expectedBalance Decimal  @db.Decimal(10, 2)
  actualBalance   Decimal? @db.Decimal(10, 2)  // User can set this
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([date])
}

// Track all unique decision paths in the system
model DecisionPath {
  id          String   @id @default(cuid())
  name        String   @unique  // e.g., "take-new-job", "buy-house"
  description String?
  createdAt   DateTime @default(now())

  // Relations
  scenarioDecisionPaths ScenarioSetDecisionPath[]
  projectionEvents      ProjectionEvent[]
  recurringRules        RecurringProjectionEventRule[]
}

// Named scenario configurations
model ScenarioSet {
  id          String   @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean  @default(false)  // The "all enabled" default scenario
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  decisionPaths ScenarioSetDecisionPath[]

  @@index([isDefault])
}

// Junction table: which decision paths are enabled in each scenario
model ScenarioSetDecisionPath {
  id             String       @id @default(cuid())
  scenarioSetId  String
  decisionPathId String
  enabled        Boolean      @default(true)

  scenarioSet    ScenarioSet  @relation(fields: [scenarioSetId], references: [id], onDelete: Cascade)
  decisionPath   DecisionPath @relation(fields: [decisionPathId], references: [id], onDelete: Cascade)

  @@unique([scenarioSetId, decisionPathId])
  @@index([scenarioSetId])
  @@index([decisionPathId])
}
